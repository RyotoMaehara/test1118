<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdnUI Experiment Demo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Hiragino+Kaku+Gothic+ProN&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. 基本設定 (Reset & Base) --- */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Inter', "Hiragino Kaku Gothic ProN", sans-serif; 
            background-color: #222; 
            color: #fff; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            overflow-x: hidden; 
            padding: 20px; /* スマホで端が詰まらないように余白 */
        }
        
        /* --- 2. スタート・終了画面 --- */
        .info-container { 
            text-align: center; 
            width: 100%;
            max-width: 600px; 
            padding: 2rem; 
            background: #333; 
            border-radius: 12px; 
            display: none; /* 初期状態は非表示 */
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
        }
        .info-container.active { display: block; animation: fadeIn 0.5s ease; }
        
        .title-large { font-size: 1.8rem; font-weight: bold; margin-bottom: 1rem; }
        .desc-text { font-size: 1rem; color: #ccc; margin-bottom: 2rem; line-height: 1.6; }
        
        .btn-start { 
            background: linear-gradient(135deg, #309afa, #2563eb); 
            color: white; border: none; padding: 1.2rem 3rem; border-radius: 50px; 
            font-size: 1.2rem; font-weight: bold; cursor: pointer; 
            box-shadow: 0 5px 15px rgba(48, 154, 250, 0.4); transition: 0.3s; 
        }

        /* 振り返り用リンク */
        .review-links { margin-top: 2rem; border-top: 1px solid #555; padding-top: 1rem; text-align: left; }
        .review-link-item { display: block; padding: 10px; color: #aaa; text-decoration: none; border-bottom: 1px solid #444; transition: 0.2s; }
        .review-link-item:hover { color: #fff; background: #444; padding-left: 15px; }

        /* --- 3. 実験画面レイアウト (スマホ対応) --- */
        .page-header { position: absolute; top: 20px; text-align: center; z-index: 10; width: 100%; pointer-events: none; }
        .step-badge { display: inline-block; background: rgba(0,0,0,0.6); color: #fff; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; border: 1px solid #555; }

        /* ★動画エリア (レスポンシブ対応) */
        .video-wrapper { 
            position: relative; 
            width: 100%;             /* 横幅いっぱい */
            max-width: 640px;        /* PCでは640pxで止める */
            aspect-ratio: 16 / 9;    /* アスペクト比を固定 */
            background: #000; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
            border-radius: 8px; 
            overflow: hidden; 
            display: none; 
        }
        .video-wrapper.active { display: block; }
        video { width: 100%; height: 100%; object-fit: cover; }

        /* --- 4. UIオーバーレイ --- */
        .popup-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            z-index: 50; visibility: hidden; opacity: 0; 
            transition: opacity 0.5s ease;
        }
        .popup-overlay.is-visible { visibility: visible; opacity: 1; }

        .bg-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; z-index: -1; filter: brightness(0.4); }
        .choices-container { 
            display: flex; flex-direction: row; gap: 20px; width: 100%; padding: 20px; 
            justify-content: center; align-items: center; flex-wrap: wrap; /* スマホでボタンがはみ出ないよう折り返し許可 */
        }

        /* スキップボタン (動画上の×) */
        .skip-btn {
            position: absolute; top: 15px; right: 15px;
            background: rgba(0, 0, 0, 0.5); color: #fff; border: 1px solid #999;
            width: 36px; height: 36px; border-radius: 50%;
            font-size: 1.2rem; line-height: 1; cursor: pointer; pointer-events: auto;
            display: flex; justify-content: center; align-items: center;
            transition: 0.2s; z-index: 60; opacity: 0; transform: scale(0.8);
        }
        .skip-btn:hover { background: rgba(255, 255, 255, 0.2); border-color: #fff; }
        .popup-overlay.is-visible .skip-btn {
            opacity: 1; transform: scale(1);
            transition: opacity 0.3s ease 0.5s, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) 0.5s;
        }

        /* --- 5. アニメーション定義 (下から飛び出す) --- */
        @keyframes popUpSlide {
            0% { opacity: 0; transform: translateY(60px) scale(0.8); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* --- 6. ボタンデザイン --- */
        /* Control (従来型) */
        .btn-control { background: #fff; color: #333; border: 1px solid #ccc; padding: 10px 30px; border-radius: 4px; font-size: 1rem; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); pointer-events: auto; }
        
        /* Experimental (提案型 - マテリアル感) */
        .btn-tactile {
            width: 160px; height: 120px; border: none; border-radius: 20px; color: white; font-size: 1.1rem; font-weight: bold;
            cursor: pointer; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center;
            /* 通常時の影 */
            box-shadow: 0 10px 20px rgba(0,0,0,0.5), inset 0 2px 0 rgba(255,255,255,0.2); 
            transition: all 0.1s ease; 
            pointer-events: auto;
            opacity: 0; /* アニメーション前は隠す */
        }

        /* 表示時のアニメーション適用 */
        .popup-overlay.is-visible .btn-tactile { animation: popUpSlide 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .popup-overlay.is-visible .btn-tactile:nth-child(2) { animation-delay: 0.1s; } /* 2つ目は少し遅らせる */

        .btn-tactile:hover { transform: translateY(-5px) scale(1.05); box-shadow: 0 15px 30px rgba(0,0,0,0.6), inset 0 2px 0 rgba(255,255,255,0.4); }
        
        /* ★クリック時の押し込み演出 */
        .btn-tactile:active { 
            transform: translateY(4px) scale(0.96) !important; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.5), inset 0 2px 0 rgba(255,255,255,0.2) !important;
        }
        /* ★連打防止（無効化時）のスタイル */
        .btn-tactile:disabled, .btn-control:disabled {
            cursor: default; opacity: 0.7; pointer-events: none;
        }

        .btn-tactile span { font-size: 0.8rem; font-weight: normal; margin-top: 5px; opacity: 0.9; }
        .btn-1_orange { background: linear-gradient(135deg, #ff6b6b, #ee5253); }
        .btn-2_blue { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .btn-blue { background: linear-gradient(135deg, #4facfe, #00f2fe); width: 200px; }

        /* --- 7. iFrame (Webサイト表示) エリア --- */
        .iframe-wrapper { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; background: #fff; display: none; }
        .iframe-wrapper.active { display: block; }
        .iframe-content { width: 100%; height: 100%; border: none; }
        .close-iframe-btn {
            position: absolute; top: 10px; right: 10px; z-index: 101;
            background: #ef4444; color: #fff; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .question-text { 
            position: absolute; top: 15%; width: 100%; text-align: center; font-size: 1.5rem; text-shadow: 0 2px 4px rgba(0,0,0,0.8); font-weight: bold; 
            opacity: 0; transform: translateY(-20px); transition: all 0.5s ease 0.2s; 
            padding: 0 10px; /* スマホで文字が切れないように */
        }
        .popup-overlay.is-visible .question-text { opacity: 1; transform: translateY(0); }
        
        .hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="startView" class="info-container">
        <h1 class="title-large">動画広告体験デモ</h1>
        <p class="desc-text">これより3パターンの広告が表示されます。<br>X(閉じる)ボタンで次へ進みます。</p>
        <button class="btn-start" onclick="startExperiment()">開始</button>
    </div>

    <div id="finishView" class="info-container">
        <h1 class="title-large">全てのステップが終了しました。</h1>
        <p class="desc-text">ご協力ありがとうございました。<br>アンケート回答にお戻りください。</p>
        <div class="review-links">
            <p style="font-size:0.9rem; color:#888; margin-bottom:10px;">▼ for administrative</p>
            <a href="?step=1" class="review-link-item">S1_control</a>
            <a href="?step=2" class="review-link-item">S2_single</a>
            <a href="?step=3" class="review-link-item">S3_double</a>
        </div>
    </div>

    <div id="experimentView" class="video-wrapper">
        <div class="page-header"><span id="stepBadge" class="step-badge">Step 1</span></div>
        <video id="myVideo" playsinline width="640" height="360" muted>
            <source src="demo_video.mp4" type="video/mp4"> </video>

        <div id="interstitialOverlay" class="popup-overlay">
            <div id="bgLayer" class="bg-layer"></div>
            <button id="skipOverlayBtn" class="skip-btn">✕</button>
            <div id="questionText" class="question-text hidden">今の気分はどっち？</div>
            <div id="choicesContainer" class="choices-container"></div>
        </div>

        <div id="iframeWrapper" class="iframe-wrapper">
            <button id="closeIframeBtn" class="close-iframe-btn">✕（次へ進む）</button>
            <iframe id="interstitialFrame" class="iframe-content" src=""></iframe>
        </div>
    </div>

    <script>
        // ▼▼▼ GAS設定 (URLを書き換えてください) ▼▼▼
        const POST_URL = 'https://script.google.com/macros/s/AKfycbzzMRUbz5eVpJGZPmGPRQ8rlHZvaS10ySDvFphGwOGqz15avk5dwSrmBp_TIgZlQEEK/exec';

        // --- 設定データ ---
        // videoSrc: 同じ動画ファイルを指定して比較検証を行う
        // bgImage: 動画のラストシーンの静止画を指定すると、よりシームレスになります
        const scenarioConfig = {
            1: {
                type: 'control', videoSrc: "4_video_outdoor.mp4", bgImage: "image_4_outdoor.png", 
                choices: [ { text: "詳しくはこちら", url: "https://enjoy-minakami.jp/", style: "btn-control" } ],
                question: null
            },
            2: {
                type: 'single', videoSrc: "4_video_outdoor.mp4", bgImage: "image_4_outdoor.png",
                choices: [ { text: "詳しくはこちら<br><span>公式サイトを見る</span>", url: "https://enjoy-minakami.jp/outdoor.php", style: "btn-tactile btn-blue" } ],
                question: null
            },
            3: {
                type: 'double', videoSrc: "4_video_outdoor.mp4", bgImage: "image_4_outdoor.png",
                choices: [
                    { text: "温泉！<br><span>Relax</span>", url: "https://enjoy-minakami.jp/spa.php", style: "btn-tactile btn-1_orange" },
                    { text: "スキー！<br><span>Active</span>", url: "https://enjoy-minakami.jp/outdoor.php", style: "btn-tactile btn-2_blue" }
                ],
                question: "冬の旅行先といえば？"
            }
        };

        // --- ID管理 (トップに戻ると新規発行、実験中は維持) ---
        const urlParams = new URLSearchParams(window.location.search);
        let currentStep = parseInt(urlParams.get('step'));
        let USER_ID;

        if (!currentStep) {
            // トップ画面(Step指定なし)に来たら、必ず新しいIDを生成して保存
            USER_ID = 'user_' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('exp_user_id', USER_ID);
        } else {
            // 実験中は保存されたIDを使用
            USER_ID = sessionStorage.getItem('exp_user_id');
            if (!USER_ID) { // 直リンクなどでIDが無い場合
                USER_ID = 'user_' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('exp_user_id', USER_ID);
            }
        }
        
        // --- 要素取得 ---
        const startView = document.getElementById('startView');
        const finishView = document.getElementById('finishView');
        const experimentView = document.getElementById('experimentView');
        const stepBadge = document.getElementById('stepBadge');
        
        const video = document.getElementById('myVideo');
        const overlay = document.getElementById('interstitialOverlay');
        const choicesContainer = document.getElementById('choicesContainer');
        const questionText = document.getElementById('questionText');
        const bgLayer = document.getElementById('bgLayer');
        
        const skipOverlayBtn = document.getElementById('skipOverlayBtn');
        const iframeWrapper = document.getElementById('iframeWrapper');
        const iframe = document.getElementById('interstitialFrame');
        const closeIframeBtn = document.getElementById('closeIframeBtn');

        // --- 初期表示処理 ---
        if (!currentStep) {
            startView.classList.add('active');
        } else if (currentStep > 3) {
            finishView.classList.add('active');
        } else {
            experimentView.classList.add('active');
            setupScenario(currentStep);
        }

        // 実験開始
        function startExperiment() { window.location.href = "?step=1"; }

        // シナリオセットアップ
        function setupScenario(stepIndex) {
            const data = scenarioConfig[stepIndex];
            video.src = data.videoSrc;
            stepBadge.textContent = `Step ${stepIndex}`;
            
             bgLayer.style.backgroundImage = `url('${data.bgImage}')`;
            
            choicesContainer.innerHTML = '';
            data.choices.forEach((choice, idx) => {
                const btn = document.createElement('button');
                btn.innerHTML = choice.text;
                btn.className = choice.style;
                
                // クリックイベント
                btn.onclick = function() {
                    // ★連打防止: 全ボタンを無効化
                    const allBtns = choicesContainer.querySelectorAll('button');
                    allBtns.forEach(b => b.disabled = true);

                    sendLogToGAS(stepIndex, `btn-${idx}`, choice.text, "click");
                    
                    // 0.1秒待ってから遷移（押し込みアニメーションを見せるため）
                    setTimeout(() => {
                        overlay.classList.remove('is-visible'); 
                        setTimeout(() => showIframe(choice.url), 300);
                    }, 100); 
                };
                choicesContainer.appendChild(btn);
            });

            if (data.question) {
                questionText.textContent = data.question;
                questionText.classList.remove('hidden');
            } else {
                questionText.classList.add('hidden');
            }

            // 動画リセット＆再生
            video.currentTime = 0;
            video.muted = true; // 自動再生のためミュート推奨
            video.play().catch(e => console.log("Autoplay blocked", e));
        }

        // 動画終了イベント
        video.addEventListener('ended', () => {
            const data = scenarioConfig[currentStep];
            sendLogToGAS(currentStep, "video", "Video Ended", "view");
            overlay.classList.add('is-visible');
            overlay.style.backgroundColor = data.type === 'control' ? 'rgba(0,0,0,0.7)' : 'rgba(0,0,0,0.4)';
        });

        // iFrame表示
        function showIframe(url) {
            iframe.src = url;
            iframeWrapper.classList.add('active');
        }

        // 次のステップへ進む
        function proceedToNextStep() {
            const nextStep = currentStep + 1;
            setTimeout(() => {
                window.location.href = `?step=${nextStep}`;
            }, 300);
        }

        // Webサイト閲覧後の閉じるボタン
        closeIframeBtn.onclick = () => {
            iframeWrapper.classList.remove('active');
            iframe.src = "";
            proceedToNextStep();
        };

        // オーバーレイのスキップボタン（動画上の×）
        skipOverlayBtn.onclick = () => {
            sendLogToGAS(currentStep, "skip-btn", "Overlay Skip", "skipped");
            overlay.classList.remove('is-visible');
            proceedToNextStep();
        };

        // ログ送信
        function sendLogToGAS(step, buttonId, targetName, action) {
            if (POST_URL.includes('XXXX')) return; // URL未設定時は送信しない
            const data = {
                userId: USER_ID, step: step, buttonId: buttonId, 
                target: targetName, action: action, timestamp: new Date().toISOString()
            };
            fetch(POST_URL, {
                method: 'POST', mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(data)
            }).catch(console.error);
        }
    </script>
</body>
</html>
